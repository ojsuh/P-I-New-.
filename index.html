<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P.I. New 2.0 Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    <style id="custom-bg-style"></style>
    <style>
        /* General Styling & THEME VARIABLES */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Nunito', sans-serif; }
        :root {
            /* Light Theme (Default) */
            --app-bg: #f0f2f5;
            --primary-gradient: linear-gradient(135deg, #a5b4fc, #6366f1);
            --btn-primary: #8b5cf6;
            --btn-secondary: #ec4899;
            --btn-danger: #ef4444;
            --user-msg-bg: #8b5cf6;
            --ai-msg-bg: #ffffff;
            --header-bg: #ffffff;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --input-bg: #f3f4f6;
            --border-color: #e5e7eb;
            --sidebar-bg: #ffffff;
            --modal-bg: #ffffff;
            --code-bg: #1e293b;
            --msg-bg-opacity: 1;
        }
        body.dark-theme {
            /* Dark Theme */
            --app-bg: #121212;
            --btn-primary: #a78bfa;
            --user-msg-bg: #7c3aed;
            --ai-msg-bg: #2d2d2d;
            --header-bg: #1e1e1e;
            --card-bg: rgba(30, 30, 30, 0.95);
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --input-bg: #374151;
            --border-color: #4b5563;
            --sidebar-bg: #1e1e1e;
            --modal-bg: #2d2d2d;
            --code-bg: #0f172a;
        }
        
        /* Custom Background Styling */
        body.custom-bg-active #chat-view {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        body.custom-bg-active .ai-message { background-color: rgba(255, 255, 255, 0.85); }
        body.custom-bg-active .user-message { background-color: rgba(139, 92, 246, 0.9); }
        body.custom-bg-active.dark-theme .ai-message { background-color: rgba(45, 45, 45, 0.8); }
        body.custom-bg-active.dark-theme .user-message { background-color: rgba(124, 58, 237, 0.85); }


        html, body { height: 100%; overflow: hidden; background-color: var(--app-bg); color: var(--text-primary); }
        body.menu-open { overflow: hidden; }

        .view { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; overflow-y: auto; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .view.active { display: flex; flex-direction: column; opacity: 1; }
        
        /* Loading Screen Animation */
        #loading-view {
            background: linear-gradient(135deg, #a5b4fc, #6366f1);
            color: white;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 9999;
            flex-direction: column;
        }
        .loading-animation-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .logo-formation {
            width: 100px;
            height: 100px;
            position: relative;
            margin-bottom: 30px;
        }
        .logo-formation .arc {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 8px solid transparent;
            position: absolute;
            top: 0;
            left: 0;
        }
        .logo-formation .arc.top {
            border-top-color: white;
            animation: rotate-arc-1 1.2s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        }
        .logo-formation .arc.bottom {
            border-bottom-color: white;
            animation: rotate-arc-2 1.2s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        }
        .logo-formation .logo-text {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            font-weight: 800;
            color: white;
            opacity: 0;
            transform: scale(0.8);
            animation: fade-in-logo-text 0.5s ease-out 1s forwards;
        }
        .animated-title, .animated-subtitle {
            opacity: 0;
            transform: translateY(20px);
            animation: fade-in-up 0.6s ease-out 1.3s forwards;
        }
        .animated-title { font-size: 24px; font-weight: 700; margin-bottom: 5px; }
        .animated-subtitle { font-size: 16px; opacity: 0; }

        @keyframes rotate-arc-1 {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes rotate-arc-2 {
            from { transform: rotate(70deg); }
            to { transform: rotate(430deg); }
        }
        @keyframes fade-in-logo-text {
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fade-in-up {
            to { opacity: 1; transform: translateY(0); }
        }

        /* Login/Register Page */
        #login-view, #register-view { background: var(--primary-gradient); justify-content: center; align-items: center; }
        .card { background: var(--card-bg); backdrop-filter: blur(10px); border-radius: 24px; padding: 40px 30px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); width: 100%; max-width: 450px; margin: 20px; }
        .logo { width: 100px; height: 100px; margin: 0 auto 20px; background: linear-gradient(135deg, #8b5cf6, #ec4899); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-size: 28px; font-weight: 800; }
        .title { text-align: center; font-size: 28px; font-weight: 700; margin-bottom: 10px; color: var(--text-primary); }
        .subtitle { text-align: center; color: var(--text-secondary); margin-bottom: 30px; font-size: 16px; }
        .form-group { margin-bottom: 20px; position: relative; }
        label { display: block; margin-bottom: 8px; font-size: 14px; color: var(--text-secondary); font-weight: 600; }
        input { width: 100%; padding: 14px 45px 14px 18px; background: var(--input-bg); border: 2px solid var(--border-color); border-radius: 12px; font-size: 16px; color: var(--text-primary); }
        input:focus { outline: none; border-color: var(--btn-primary); }
        .password-toggle { position: absolute; right: 15px; top: 50%; transform: translateY(10%); cursor: pointer; color: var(--text-secondary); }
        .btn { width: 100%; padding: 16px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; text-decoration: none; border: none; color: white; background: var(--btn-primary); }
        .footer-text { text-align: center; margin-top: 20px; font-size: 14px; color: var(--text-secondary); }
        .link { color: var(--btn-primary); cursor: pointer; font-weight: 700; }
        .error-message { color: var(--btn-danger); text-align: center; margin-top: 15px; min-height: 20px; font-weight: 600; }
        
        /* Mobile-First Chat UI */
        #chat-view { background-color: var(--app-bg); padding: 0; }
        .app-container { display: flex; flex-direction: column; height: 100%; width: 100%; }
        #chat-view .app-container { padding-bottom: 15px; }
        .app-header { display: flex; align-items: center; padding: 10px 15px; background: var(--header-bg); box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 100; flex-shrink: 0; }
        .menu-btn, .back-btn { background: none; border: none; cursor: pointer; padding: 8px; }
        .menu-btn .material-symbols-outlined, .back-btn .material-symbols-outlined { font-size: 28px; color: var(--text-primary); }
        .header-title { flex-grow: 1; text-align: center; font-size: 16px; font-weight: 700; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Sidebar Menu */
        .sidebar { position: fixed; top: 0; left: 0; width: 280px; height: 100%; background: var(--sidebar-bg); box-shadow: 4px 0 15px rgba(0,0,0,0.1); transform: translateX(-100%); transition: transform 0.3s ease-in-out; z-index: 1001; display: flex; flex-direction: column; padding: 20px; }
        .sidebar-header { padding: 20px 0; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; text-align: center;}
        .sidebar-header .logo { margin: 0 auto 10px; }
        .brand-text { font-size: 18px; font-weight: 700; color: var(--text-primary); }
        .model-badge { font-size: 12px; color: var(--text-secondary); }
        .sidebar nav { flex-grow: 1; }
        .sidebar nav a { display: flex; align-items: center; padding: 15px; border-radius: 10px; text-decoration: none; color: var(--text-primary); font-weight: 600; margin-bottom: 10px; transition: background-color 0.2s; }
        .sidebar nav a:hover { background-color: var(--app-bg); }
        .sidebar nav a .material-symbols-outlined { margin-right: 15px; }
        .sidebar-footer { margin-top: auto; border-top: 1px solid var(--border-color); padding-top: 10px; }
        .sidebar-footer a { color: var(--text-secondary); }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 1000; }
        body.menu-open .sidebar { transform: translateX(0); }
        body.menu-open .overlay { opacity: 1; visibility: visible; }

        /* Chat Messages */
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .message { max-width: 85%; padding: 12px 18px; border-radius: 18px; line-height: 1.5; font-size: 15px; animation: fadeIn 0.4s ease-out; display: flex; flex-direction: column; }
        .user-message { background: var(--user-msg-bg); color: white; align-self: flex-end; border-bottom-right-radius: 5px; }
        .ai-message { background: var(--ai-msg-bg); color: var(--text-primary); align-self: flex-start; border-bottom-left-radius: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .message-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; font-size: 13px; opacity: 0.8; }
        .user-upload-image { max-width: 100%; border-radius: 12px; margin-top: 8px; }
        .message-content img { max-width: 100%; border-radius: 12px; margin-top: 8px; }
        .message.loading-placeholder { flex-direction: row; align-items: center; gap: 10px; }
        .message.loading-placeholder span { font-size: 15px; font-style: italic; }
        .spinner { width: 20px; height: 20px; border: 3px solid var(--border-color); border-radius: 50%; border-top-color: var(--btn-primary); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Code Block Styling */
        .code-block { background: var(--code-bg); border-radius: 12px; margin-top: 10px; overflow: hidden; }
        .code-header { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 8px 15px; }
        .code-lang { color: #cbd5e1; font-size: 14px; font-weight: bold; text-transform: capitalize; }
        .code-actions button { background: #4a5568; color: white; border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px; margin-left: 10px; }
        .code-block pre { margin: 0; padding: 15px; overflow-x: auto; }
        .code-block code { font-family: 'Courier New', Courier, monospace; color: #e2e8f0; font-size: 14px; white-space: pre; }

        /* Chat Input */
        .chat-input-container { padding: 15px; padding-top: 0; background: transparent; flex-shrink: 0; }
        .input-group { display: flex; gap: 10px; align-items: center; padding: 8px; background-color: var(--header-bg); border-radius: 34px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);}
        .chat-input { flex: 1; padding: 12px 18px; border: none; background-color: transparent; color: var(--text-primary); border-radius: 28px; font-size: 17px; resize: none; max-height: 150px; }
        .chat-input:focus { outline: none; }
        .action-btn { padding: 12px; border-radius: 50%; width: 48px; height: 48px; flex-shrink: 0; background: var(--btn-primary); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .action-btn .material-symbols-outlined { font-size: 24px; }
        
        /* Image Preview in Input Area */
        .image-preview-container { position: relative; width: 70px; height: 70px; margin-left: 15px; margin-bottom: 10px; }
        #image-preview-thumbnail { width: 100%; height: 100%; border-radius: 10px; object-fit: cover; border: 2px solid var(--border-color); }
        #remove-image-btn { position: absolute; top: -8px; right: -8px; background: black; color: white; border-radius: 50%; width: 24px; height: 24px; border: 2px solid white; cursor: pointer; font-size: 16px; line-height: 20px; text-align: center; }

        /* History & Contact Pages */
        #history-view, #contact-view, #calculator-view { background-color: var(--app-bg); padding: 0; }
        .page-header { font-size: 24px; font-weight: 700; margin-bottom: 20px; color: var(--text-primary); }
        .history-item { background: var(--header-bg); border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .history-actions button { background: var(--input-bg); color: var(--text-primary); border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 8px; cursor: pointer; margin-right: 5px;}
        
        /* Calculator Page */
        .calculator-wrapper { width: 100%; max-width: 400px; margin: 0 auto; padding: 20px; }
        .calculator-display-container { width: 100%; background: var(--input-bg); color: var(--text-primary); padding: 20px; text-align: right; border-radius: 12px; margin-bottom: 20px; min-height: 120px; display: flex; flex-direction: column; justify-content: space-between; }
        .calculator-expression { font-size: 20px; color: var(--text-secondary); min-height: 24px; }
        .calculator-current-input { font-size: 48px; font-weight: 700; overflow-x: auto; white-space: nowrap; }
        .calculator-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .calc-btn { height: 70px; border-radius: 50%; border: none; font-size: 24px; cursor: pointer; background: var(--header-bg); color: var(--text-primary); transition: background-color 0.2s; }
        .calc-btn:hover { background-color: var(--input-bg); }
        .calc-btn.operator { color: var(--btn-primary); font-weight: bold; }
        .calc-btn.equals { background: var(--btn-primary); color: white; grid-column: 4; grid-row: 4 / 6; height: auto; border-radius: 40px; }
        .calc-btn.zero { grid-column: 1 / 3; border-radius: 40px; }
        .ai-calculator-section { margin-top: 40px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        .ai-calculator-result { margin-top: 15px; padding: 15px; background: var(--header-bg); border-radius: 12px; min-height: 50px; line-height: 1.6; }

        /* Contact Page (Full Page) */
        #contact-view .app-container { justify-content: center; text-align: center; }
        .contact-fullpage-container { padding: 20px; }
        .contact-title-large { font-size: 48px; font-weight: 800; margin-bottom: 20px; color: var(--text-primary); }
        .contact-subtitle { font-size: 18px; color: var(--text-secondary); margin-bottom: 40px; }
        .contact-socials-large { display: flex; justify-content: center; gap: 20px; margin-bottom: 40px; }
        .contact-socials-large .btn { width: auto; padding: 15px 30px; font-size: 18px; }
        .contact-info-large p { margin-bottom: 15px; font-size: 18px; display: flex; align-items: center; justify-content: center; gap: 10px; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; padding: 20px; }
        .modal-overlay.visible { display: flex; }
        .modal-content { background: var(--modal-bg); border-radius: 16px; padding: 25px; max-width: 500px; width: 100%; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: zoomIn 0.3s ease-out; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 15px; }
        .modal-header h2 { color: var(--text-primary); }
        .modal-close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary); }
        .modal-body { color: var(--text-primary); }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* Code Preview Modal */
        #code-preview-modal { padding: 0; align-items: stretch; }
        .code-preview-content { display: flex; flex-direction: column; width: 100%; height: 100%; max-width: 100%; background: var(--app-bg); border-radius: 0; }
        .code-preview-header { flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: var(--header-bg); border-bottom: 1px solid var(--border-color); }
        .code-preview-header h2 { font-size: 18px; }
        .code-preview-header .btn { width: auto; padding: 8px 15px; font-size: 14px; }
        .code-preview-body { flex-grow: 1; display: flex; overflow: hidden; }
        .code-editor-pane, .code-preview-pane { flex: 1; width: 50%; display: flex; flex-direction: column; }
        .code-editor-pane { border-right: 1px solid var(--border-color); }
        #code-editor-textarea { flex-grow: 1; border: none; outline: none; resize: none; padding: 15px; font-family: 'Courier New', Courier, monospace; font-size: 15px; background: var(--ai-msg-bg); color: var(--text-primary); }
        #code-preview-iframe { flex-grow: 1; border: none; width: 100%; height: 100%; background: white; }

    </style>
</head>
<body>
    <div id="app-root"></div>
    <input type="file" id="custom-bg-input" accept="image/*" style="display: none;">

    <script>
    // --- APP INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', function() {
        const appRoot = document.getElementById('app-root');
        // Initial HTML structure is injected here
        appRoot.innerHTML = `
            <div id="loading-view" class="view active">
                <div class="loading-animation-container">
                    <div class="logo-formation">
                        <div class="arc top"></div>
                        <div class="arc bottom"></div>
                        <div class="logo-text">PI</div>
                    </div>
                    <div class="animated-title">P.I. New 2.0 Pro</div>
                    <div class="animated-subtitle">By Paong</div>
                </div>
            </div>
            <div class="sidebar" id="sidebar-menu">
                <div class="sidebar-header">
                    <div class="logo">PI</div>
                    <div class="brand-text">P.I. New</div>
                    <div class="model-badge">2.0 Pro</div>
                </div>
                <nav>
                    <a href="#" id="menu-new-chat-btn"><span class="material-symbols-outlined">add</span>Chat Baru</a>
                    <a href="#" id="menu-history-btn"><span class="material-symbols-outlined">history</span>Riwayat</a>
                    <a href="#" id="menu-calculator-btn"><span class="material-symbols-outlined">calculate</span>Kalkulator</a>
                    <a href="#" id="menu-contact-btn"><span class="material-symbols-outlined">contact_support</span>Kontak</a>
                </nav>
                <div class="sidebar-footer">
                     <a href="#" id="menu-custom-bg-btn"><span class="material-symbols-outlined">image</span>Ubah Latar</a>
                     <a href="#" id="menu-remove-bg-btn" style="display: none;"><span class="material-symbols-outlined">hide_image</span>Hapus Latar</a>
                     <a href="#" id="theme-toggle-btn"><span class="material-symbols-outlined">contrast</span>Ganti Tema</a>
                     <a href="#" id="menu-logout-btn"><span class="material-symbols-outlined">logout</span>Logout</a>
                </div>
            </div>
            <div class="overlay" id="overlay"></div>
            <!-- Standard Modal -->
            <div id="modal" class="modal-overlay">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="modal-title"></h2>
                        <button id="modal-close-btn" class="modal-close-btn">&times;</button>
                    </div>
                    <div id="modal-body" class="modal-body"></div>
                    <div id="modal-footer" style="margin-top: 20px; text-align: right;"></div>
                </div>
            </div>
            <!-- Code Preview Modal -->
            <div id="code-preview-modal" class="modal-overlay">
                <div class="code-preview-content">
                    <header class="code-preview-header">
                        <h2>Pratinjau & Edit Kode</h2>
                        <div>
                            <button id="request-fix-btn" class="btn btn-secondary" style="margin-right: 10px;">Minta Perbaikan/Tambahan ke AI</button>
                            <button id="code-preview-close-btn" class="modal-close-btn">&times;</button>
                        </div>
                    </header>
                    <div class="code-preview-body">
                        <div class="code-editor-pane">
                            <textarea id="code-editor-textarea"></textarea>
                        </div>
                        <div class="code-preview-pane">
                            <iframe id="code-preview-iframe"></iframe>
                        </div>
                    </div>
                </div>
            </div>
            <div id="login-view" class="view">
                <div class="card">
                    <div class="logo">PI</div>
                    <h1 class="title">Selamat Datang</h1>
                    <div class="subtitle">Login untuk melanjutkan</div>
                    <form id="login-form">
                        <div class="form-group"><label for="login-username">Username</label><input type="text" id="login-username" required></div>
                        <div class="form-group"><label for="login-password">Password</label><input type="password" id="login-password" required><span class="material-symbols-outlined password-toggle">visibility_off</span></div>
                        <button type="submit" class="btn">Login</button>
                        <div class="footer-text">Belum punya akun? <span class="link" id="go-to-register-btn">Daftar</span></div>
                    </form>
                    <div id="login-error" class="error-message"></div>
                </div>
            </div>
            <div id="register-view" class="view">
                <div class="card">
                    <div class="logo">PI</div>
                    <h1 class="title">Buat Akun Baru</h1>
                    <form id="register-form">
                        <div class="form-group"><label for="register-username">Username</label><input type="text" id="register-username" required></div>
                        <div class="form-group"><label for="register-password">Password</label><input type="password" id="register-password" required><span class="material-symbols-outlined password-toggle">visibility_off</span></div>
                        <div class="form-group"><label for="register-confirm">Konfirmasi Password</label><input type="password" id="register-confirm" required><span class="material-symbols-outlined password-toggle">visibility_off</span></div>
                        <button type="submit" class="btn btn-secondary">Daftar</button>
                        <div class="footer-text">Sudah punya akun? <span class="link" id="go-to-login-btn">Login</span></div>
                    </form>
                    <div id="register-error" class="error-message"></div>
                </div>
            </div>
            <div id="chat-view" class="view">
                <div class="app-container">
                    <header class="app-header">
                        <button class="menu-btn" id="hamburger-btn"><span class="material-symbols-outlined">menu</span></button>
                        <div class="header-title" id="chat-title">P.I. New</div>
                        <div style="width: 44px;"></div> <!-- Spacer -->
                    </header>
                    <main class="chat-messages" id="chat-messages"></main>
                    <footer class="chat-input-container">
                        <div id="image-preview-container" class="image-preview-container" style="display: none;">
                            <img id="image-preview-thumbnail" src="" alt="Image preview"/>
                            <button id="remove-image-btn" class="remove-image-btn">&times;</button>
                        </div>
                        <div class="input-group">
                            <button id="upload-btn" class="action-btn" title="Unggah gambar"><span class="material-symbols-outlined">add_photo_alternate</span></button>
                            <textarea id="chat-input" class="chat-input" placeholder="Ketik pesan..." rows="1"></textarea>
                            <button id="send-btn" class="action-btn" title="Kirim"><span class="material-symbols-outlined">send</span></button>
                        </div>
                        <input type="file" id="file-input" accept="image/*" style="display: none">
                    </footer>
                </div>
            </div>
            <div id="history-view" class="view">
                <div class="app-container" style="padding: 20px;">
                    <header class="app-header" style="position: static; margin-bottom: 20px;">
                        <button class="back-btn" id="back-to-chat-from-history"><span class="material-symbols-outlined">arrow_back</span></button>
                        <h1 class="header-title">Riwayat Percakapan</h1>
                        <div style="width: 44px;"></div>
                    </header>
                    <div id="history-list" style="width: 100%;"></div>
                </div>
            </div>
            <div id="contact-view" class="view">
                <div class="app-container">
                     <header class="app-header" style="position: static;">
                        <button class="back-btn" id="back-to-chat-from-contact"><span class="material-symbols-outlined">arrow_back</span></button>
                        <h1 class="header-title">Kontak</h1>
                        <div style="width: 44px;"></div>
                    </header>
                    <div class="contact-fullpage-container">
                        <h1 class="contact-title-large">P.I. New by Paong</h1>
                        <p class="contact-subtitle">Terhubung dengan kami melalui media sosial.</p>
                        <div class="contact-socials-large">
                            <a href="https://discord.gg/Mv3m7mtr" target="_blank" class="btn" style="background: #5865F2;">Join Discord</a>
                            <a href="https://www.tiktok.com/@pinewaioficial?_t=ZS-8yGrl19Ny4n&_r=1" target="_blank" class="btn" style="background: black;">TikTok</a>
                        </div>
                        <div class="contact-info-large">
                            <p><span class="material-symbols-outlined">call</span> +62 882-2670-5434</p>
                            <p><span class="material-symbols-outlined">email</span> bypaongpinew@gmail.com</p>
                        </div>
                    </div>
                </div>
            </div>
            <div id="calculator-view" class="view">
                <div class="app-container" style="padding: 20px;">
                     <header class="app-header" style="position: static; margin-bottom: 20px;">
                        <button class="back-btn" id="back-to-chat-from-calculator"><span class="material-symbols-outlined">arrow_back</span></button>
                        <h1 class="header-title">Kalkulator</h1>
                        <div style="width: 44px;"></div>
                    </header>
                    <div class="calculator-wrapper">
                        <div class="calculator-display-container">
                            <div id="calculator-expression" class="calculator-expression"></div>
                            <div id="calculator-current-input" class="calculator-current-input">0</div>
                        </div>
                        <div class="calculator-grid">
                            <button class="calc-btn operator">C</button><button class="calc-btn operator">%</button><button class="calc-btn operator">⌫</button><button class="calc-btn operator">÷</button>
                            <button class="calc-btn">7</button><button class="calc-btn">8</button><button class="calc-btn">9</button><button class="calc-btn operator">×</button>
                            <button class="calc-btn">4</button><button class="calc-btn">5</button><button class="calc-btn">6</button><button class="calc-btn operator">-</button>
                            <button class="calc-btn">1</button><button class="calc-btn">2</button><button class="calc-btn">3</button><button class="calc-btn operator">+</button>
                            <button class="calc-btn zero">0</button><button class="calc-btn">,</button><button class="calc-btn equals">=</button>
                        </div>
                        <div class="ai-calculator-section">
                            <h2 class="page-header" style="font-size: 20px; text-align: center;">Kalkulator AI Pintar</h2>
                            <p style="text-align: center; margin-bottom: 15px; color: var(--text-secondary);">Unggah gambar soal matematika Anda</p>
                            <button id="ai-calc-upload-btn" class="btn"><span class="material-symbols-outlined">photo_camera</span>Unggah Soal</button>
                            <input type="file" id="ai-calc-file-input" accept="image/*" style="display: none;">
                            <div id="ai-calculator-result" class="ai-calculator-result">Hasil analisis AI akan muncul di sini...</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const app = {};
        window.app = app;
        
        // --- APP STATE ---
        app.currentUser = null;
        let currentChat = null;
        let uploadedImageBase64 = null;
        let currentCodePreview = { lang: '', code: '' };
        
        // --- API KEYS & CONFIGURATION ---
        // NEW: Array of Gemini API keys for fallback mechanism
        const GEMINI_API_KEYS = [
            "AIzaSyC7oQxORL-VoE7psJs5iXbRYUx2JUNPSC0", // Primary
            "AIzaSyAmD2ZIZDjs0LdqqRb77HjRFQyXtdyzeCw", // Fallback 1
            "AIzaSyAt7wdqsFbmdRjC1-PGP7SNlMFk2dxSvuQ"  // Fallback 2
        ];
        const STABILITY_API_KEY = "sk-XJfxit1Yys7FDsNZJ4FdlXamz1qUrP6brjdp7ntzTEbDJY7Z";
        let currentGeminiKeyIndex = 0;

        // --- USER-SPECIFIC DATA STORAGE ---
        const getUserKey = (key) => {
            if (!app.currentUser) return null;
            return `pi_new_${app.currentUser}_${key}`;
        };

        const getStoredData = (key) => {
            const userKey = getUserKey(key);
            if (!userKey) return null;
            const data = localStorage.getItem(userKey);
            try {
                return data ? JSON.parse(data) : null;
            } catch (e) {
                console.error("Error parsing JSON from localStorage", e);
                return null;
            }
        };

        const saveStoredData = (key, data) => {
            const userKey = getUserKey(key);
            if (!userKey) return;
            try {
                localStorage.setItem(userKey, JSON.stringify(data));
            } catch (e) {
                console.error("Error saving JSON to localStorage", e);
            }
        };

        // --- THEME MANAGEMENT ---
        function applyTheme(theme) {
            const themeBtn = document.getElementById('theme-toggle-btn');
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
                if(themeBtn) themeBtn.innerHTML = `<span class="material-symbols-outlined">light_mode</span>Mode Terang`;
            } else {
                document.body.classList.remove('dark-theme');
                if(themeBtn) themeBtn.innerHTML = `<span class="material-symbols-outlined">dark_mode</span>Mode Gelap`;
            }
        }

        function toggleTheme() {
            const currentTheme = getStoredData('theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            saveStoredData('theme', newTheme);
            applyTheme(newTheme);
        }

        // --- Custom Background ---
        function applyCustomBg(base64String) {
            if (base64String) {
                const styleEl = document.getElementById('custom-bg-style');
                styleEl.innerHTML = `#chat-view { background-image: url(${base64String}); }`;
                document.body.classList.add('custom-bg-active');
                document.getElementById('menu-remove-bg-btn').style.display = 'flex';
            }
        }

        function removeCustomBg() {
            saveStoredData('custom_bg', null);
            document.getElementById('custom-bg-style').innerHTML = '';
            document.body.classList.remove('custom-bg-active');
            document.getElementById('menu-remove-bg-btn').style.display = 'none';
        }

        function handleCustomBgUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const base64String = e.target.result;
                try {
                    saveStoredData('custom_bg', base64String);
                    applyCustomBg(base64String);
                } catch (error) {
                    alert('Gagal menyimpan gambar. Ukuran gambar mungkin terlalu besar.');
                    console.error('Error saving custom background:', error);
                }
            };
            reader.readAsDataURL(file);
        }


        // --- VIEW NAVIGATION ---
        function navigate(viewId) {
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            const viewElement = document.getElementById(viewId);
            if(viewElement) {
                viewElement.classList.add('active');
            }
            if (viewId === 'chat-view') {
                setTimeout(() => document.getElementById('chat-input')?.focus(), 100);
            }
        }
        
        // --- AI RESPONSE STREAMING ---
        function streamMessage(messageElement, fullText) {
            const sanitizedText = fullText.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const words = sanitizedText.split(' ');
            let currentText = '';
            let wordIndex = 0;

            const updateText = () => {
                let formattedText = currentText
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/\n/g, '<br>');
                
                if (wordIndex < words.length) {
                    messageElement.innerHTML = formattedText + '▌';
                } else {
                    messageElement.innerHTML = formattedText;
                }
            };

            const interval = setInterval(() => {
                if (wordIndex < words.length) {
                    currentText += words[wordIndex] + ' ';
                    updateText();
                    wordIndex++;
                } else {
                    clearInterval(interval);
                    updateText();
                }
            }, 50);
        }

        // --- CHAT MESSAGE HANDLING ---
        function addMessage(sender, content, type = 'text') {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            let messageContentHTML = '';
            if (type === 'loading') {
                messageDiv.classList.add('loading-placeholder');
                messageContentHTML = `<div class="spinner"></div><span>${content}</span>`;
            } else if (type === 'image') {
                messageContentHTML = `<div class="message-content"><p>Berikut gambar yang Anda minta:</p><img src="${content}" alt="Generated by AI"><button class="btn download-btn" onclick="window.app.downloadImage('${content}', 'pi-new-image.png')"><span class="material-symbols-outlined">download</span> Download</button></div>`;
            } else if (type === 'code') {
                const codeData = JSON.parse(content);
                const lang = codeData.language;
                const code = codeData.code.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                messageContentHTML = `<div class="message-content">
                    <p>Berikut kode ${lang} yang Anda minta:</p>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-lang">${lang}</span>
                            <div class="code-actions">
                                <button class="preview-code-btn" onclick="window.app.previewCode(this)">Pratinjau</button>
                                <button class="copy-code-btn" onclick="window.app.copyCode(this)">Salin</button>
                            </div>
                        </div>
                        <pre><code>${code}</code></pre>
                    </div>
                </div>`;
            } else if (sender === 'user' && content.includes('<img')) {
                 messageContentHTML = `<div class="message-content">${content}</div>`;
            } else {
                let formattedContent = content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                formattedContent = formattedContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/\n/g, '<br>');
                messageContentHTML = `<div class="message-content">${formattedContent}</div>`;
            }

            messageDiv.innerHTML = `<div class="message-header"><span class="material-symbols-outlined">${sender === 'user' ? 'person' : 'smart_toy'}</span><span>${sender === 'user' ? 'Anda' : 'Paong 2.0 Pro'}</span></div>` + messageContentHTML;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageDiv;
        }
        
        // --- API CALLS with FALLBACK/ERROR HANDLING ---
        async function queryGemini(chatHistory, imageBase64 = null) {
            const model = 'gemini-1.5-flash-latest';
            
            for (let i = 0; i < GEMINI_API_KEYS.length; i++) {
                const currentKey = GEMINI_API_KEYS[currentGeminiKeyIndex];
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${currentKey}`;
                
                let contents = chatHistory.map(msg => ({ 
                    role: msg.role === 'ai' ? 'model' : 'user', 
                    parts: [{ text: msg.apiContent }] 
                }));

                if (imageBase64) {
                    const lastUserMessage = contents.pop();
                    const userPromptText = lastUserMessage?.parts[0]?.text || '';
                    const multimodalMessage = {
                        role: 'user',
                        parts: [
                            { text: userPromptText },
                            {
                                inline_data: {
                                    mime_type: imageBase64.split(';')[0].split(':')[1],
                                    data: imageBase64.split(',')[1]
                                }
                            }
                        ]
                    };
                    contents.push(multimodalMessage);
                }
                
                try {
                    console.log(`Mencoba API Key index ${currentGeminiKeyIndex}...`);
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents }) });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error.message || `HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (!data.candidates || data.candidates.length === 0 || !data.candidates[0].content) {
                        throw new Error("Respons tidak valid atau diblokir oleh filter keamanan.");
                    }
                    
                    console.log(`Sukses dengan API Key index ${currentGeminiKeyIndex}.`);
                    return data.candidates[0].content.parts[0].text; // Success, return result

                } catch (error) {
                    console.error(`Gagal dengan API Key index ${currentGeminiKeyIndex}:`, error.message);
                    currentGeminiKeyIndex = (currentGeminiKeyIndex + 1) % GEMINI_API_KEYS.length; // Move to next key
                    
                    if (i === GEMINI_API_KEYS.length - 1) { // If this was the last key
                        throw new Error("Semua API Key gagal. Layanan mungkin sedang tidak tersedia.");
                    }
                }
            }
        }

        async function generateImageWithStability(prompt) {
            const url = "https://api.stability.ai/v1/generation/stable-diffusion-v1-6/text-to-image";
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json', 'Authorization': `Bearer ${STABILITY_API_KEY}` },
                body: JSON.stringify({ text_prompts: [{ text: prompt }], cfg_scale: 7, height: 1024, width: 1024, steps: 30, samples: 1 }),
            });
            if (!response.ok) {
                const errorText = await response.text();
                console.error("Stability AI Error:", errorText);
                throw new Error(`Stability AI: ${errorText || 'Gagal membuat gambar.'}`);
            }
            const responseJSON = await response.json();
            return `data:image/png;base64,${responseJSON.artifacts[0].base64}`;
        }

        // --- CORE LOGIC ---
        async function sendPromptToAI(prompt, imageBase64 = null) {
            const userMessageContent = imageBase64 ? `<img src="${imageBase64}" class="user-upload-image" alt="User upload"><p>${prompt}</p>` : prompt;
            addMessage('user', userMessageContent, 'text');
            saveMessageToHistory('user', prompt, 'text');
            
            const loadingMessage = addMessage('ai', 'AI sedang berpikir...', 'loading');
            
            try {
                let response;
                const apiHistory = currentChat.messages.map(m => ({ role: m.role, apiContent: m.apiContent }));

                if (prompt.startsWith('/gambar ')) {
                    loadingMessage.querySelector('span').textContent = 'Membuat gambar...';
                    response = await generateImageWithStability(prompt.substring(8));
                    loadingMessage.remove();
                    addMessage('ai', response, 'image');
                    saveMessageToHistory('ai', response, 'image');
                } else if (prompt.startsWith('/kode ')) {
                    loadingMessage.querySelector('span').textContent = 'Membuat kode...';
                    response = await queryGemini(apiHistory, imageBase64);
                    loadingMessage.remove();
                    const codeMatch = response.match(/```(\w*)\n([\s\S]*?)```/);
                    if (codeMatch) {
                        const codeData = { language: codeMatch[1] || 'text', code: codeMatch[2] };
                        const codeDataString = JSON.stringify(codeData);
                        addMessage('ai', codeDataString, 'code');
                        saveMessageToHistory('ai', codeDataString, 'code', codeDataString);
                    } else {
                        const aiMessageElement = addMessage('ai', '');
                        streamMessage(aiMessageElement.querySelector('.message-content'), response);
                        saveMessageToHistory('ai', response);
                    }
                } else {
                    loadingMessage.querySelector('span').textContent = imageBase64 ? 'Menganalisis gambar...' : 'Berpikir...';
                    response = await queryGemini(apiHistory, imageBase64);
                    loadingMessage.remove();
                    const aiMessageElement = addMessage('ai', '');
                    streamMessage(aiMessageElement.querySelector('.message-content'), response);
                    saveMessageToHistory('ai', response);
                }
            } catch (error) {
                console.error("AI Processing Error:", error);
                loadingMessage.remove();
                addMessage('ai', `Maaf, terjadi kesalahan: ${error.message}`);
                saveMessageToHistory('ai', `Error: ${error.message}`);
            }
        }

        async function processUserInput() {
            const input = document.getElementById('chat-input');
            const prompt = input.value.trim();
            if (!prompt && !uploadedImageBase64) return;

            const currentImage = uploadedImageBase64;
            const userPrompt = prompt || "Jelaskan gambar ini.";
            
            await sendPromptToAI(userPrompt, currentImage);
            
            resetImagePreview();
            input.value = '';
            input.style.height = 'auto';
        }

        function saveMessageToHistory(role, apiContent, type = 'text', displayContent = null) {
            if (!currentChat) return;
            const message = { 
                role, 
                apiContent,
                displayContent: displayContent || apiContent,
                type,
                timestamp: new Date().toISOString()
            };
            currentChat.messages.push(message);
            const allChats = getStoredData('chatHistory') || [];
            const chatIndex = allChats.findIndex(c => c.id === currentChat.id);
            if (chatIndex > -1) {
                if (allChats[chatIndex].title === "Percakapan Baru" && role === 'user') {
                    const newTitle = apiContent.replace(/<[^>]*>/g, '').substring(0, 30) + (apiContent.length > 30 ? '...' : '');
                    allChats[chatIndex].title = newTitle;
                    currentChat.title = newTitle;
                }
                allChats[chatIndex].messages = currentChat.messages;
                allChats[chatIndex].lastUpdated = new Date().toISOString();
                saveStoredData('chatHistory', allChats);
                document.getElementById('chat-title').textContent = currentChat.title;
            }
        }

        function createNewChatAndShow() {
            const allChats = getStoredData('chatHistory') || [];
            const newChat = { id: Date.now().toString(), title: "Percakapan Baru", messages: [], lastUpdated: new Date().toISOString() };
            allChats.unshift(newChat);
            saveStoredData('chatHistory', allChats);
            app.loadChat(newChat.id);
        }

        function renderHistoryList() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            const allChats = getStoredData('chatHistory') || [];
            
            allChats.sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated));

            if (allChats.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada riwayat.</p>';
                return;
            }
            allChats.forEach(chat => {
                const lastMsg = chat.messages.length > 0 ? chat.messages[chat.messages.length - 1].displayContent : 'Kosong';
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `<div class="history-title">${chat.title}</div><div class="history-preview">${lastMsg.replace(/<[^>]*>/g, '').substring(0,100)}</div><div class="history-actions"><button onclick="window.app.loadChat('${chat.id}')">Buka</button><button onclick="window.app.renameChat('${chat.id}')">Ganti Nama</button><button onclick="window.app.deleteChat('${chat.id}')" style="color:red;">Hapus</button></div>`;
                historyList.appendChild(historyItem);
            });
        }
        
        // --- AUTHENTICATION ---
        function handleLogin(e) {
            e.preventDefault();
            const users = JSON.parse(localStorage.getItem('pi_new_users') || '{}');
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            if (users[username] && users[username].password === password) {
                app.currentUser = username;
                localStorage.setItem('pi_new_lastUser', username);
                initializeAppUI();
            } else {
                document.getElementById('login-error').textContent = 'Username atau password salah!';
            }
        }

        function handleRegister(e) {
            e.preventDefault();
            const users = JSON.parse(localStorage.getItem('pi_new_users') || '{}');
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const confirm = document.getElementById('register-confirm').value;
            const errorEl = document.getElementById('register-error');

            if (users[username]) { errorEl.textContent = 'Username sudah digunakan!'; return; }
            if (password.length < 6) { errorEl.textContent = 'Password minimal 6 karakter!'; return; }
            if (password !== confirm) { errorEl.textContent = 'Password tidak cocok!'; return; }
            
            const proceed = () => {
                users[username] = { password: password };
                localStorage.setItem('pi_new_users', JSON.stringify(users));
                app.currentUser = username;
                localStorage.setItem('pi_new_lastUser', username);
                initializeAppUI();
            };

            if (!localStorage.getItem('pi_new_storage_consent')) {
                showStorageConsentModal(proceed);
            } else {
                proceed();
            }
        }

        function handleLogout() {
            if(confirm("Apakah Anda yakin ingin logout?")) {
                app.currentUser = null;
                currentChat = null;
                localStorage.removeItem('pi_new_lastUser');
                navigate('login-view');
            }
        }
        
        // --- APP INITIALIZATION LOGIC ---
        function initializeAppUI() {
            if (!app.currentUser) {
                navigate('login-view');
                return;
            }
            // Apply color theme
            const savedTheme = getStoredData('theme') || 'light';
            applyTheme(savedTheme);

            // Apply custom background theme
            const savedBg = getStoredData('custom_bg');
            if (savedBg) {
                applyCustomBg(savedBg);
            } else {
                removeCustomBg();
            }


            const allChats = getStoredData('chatHistory') || [];
            allChats.sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated));

            if (allChats.length > 0) {
                app.loadChat(allChats[0].id);
            } else {
                createNewChatAndShow();
            }
        }
        
        function startApp() {
            initEventListeners();
            setTimeout(() => {
                const lastUser = localStorage.getItem('pi_new_lastUser');
                if (lastUser) {
                    app.currentUser = lastUser;
                    initializeAppUI();
                } else {
                    navigate('login-view');
                }
            }, 2500); // Increased delay for new animation
        }

        // --- UTILS & HELPERS ---
        app.loadChat = (chatId) => {
            const allChats = getStoredData('chatHistory') || [];
            const chatToLoad = allChats.find(c => c.id === chatId);
            if (chatToLoad) {
                currentChat = chatToLoad;
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.innerHTML = '';
                if(currentChat.messages.length === 0){
                        const welcomeMsg = 'Halo! Saya Paong 2.0 Pro. Ada yang bisa saya bantu? Ketik /gambar untuk membuat gambar atau /kode untuk membuat kode.';
                        addMessage('ai', welcomeMsg);
                        saveMessageToHistory('ai', welcomeMsg, 'text', welcomeMsg);
                } else {
                    currentChat.messages.forEach(msg => {
                        let displayContent = msg.displayContent;
                        if (msg.role === 'user' && msg.type === 'text' && msg.apiContent.startsWith('Jelaskan gambar ini')) {
                           // This part is tricky as we don't save the image in history display.
                           // A better approach would be to save a reference. For now, we just show the text.
                        }
                         addMessage(msg.role, msg.type === 'code' ? msg.apiContent : displayContent, msg.type);
                    });
                }
                document.getElementById('chat-title').textContent = currentChat.title;
                navigate('chat-view');
            }
        };
        app.renameChat = (chatId) => {
            const newTitle = prompt('Masukkan judul baru:');
            if (newTitle && newTitle.trim()) {
                const allChats = getStoredData('chatHistory') || [];
                const chatIndex = allChats.findIndex(c => c.id === chatId);
                if (chatIndex > -1) {
                    allChats[chatIndex].title = newTitle.trim();
                    saveStoredData('chatHistory', allChats);
                    renderHistoryList();
                    if (currentChat && currentChat.id === chatId) {
                        document.getElementById('chat-title').textContent = newTitle.trim();
                    }
                }
            }
        };
        app.deleteChat = (chatId) => {
            if (confirm('Yakin ingin menghapus percakapan ini?')) {
                let allChats = getStoredData('chatHistory') || [];
                saveStoredData('chatHistory', allChats.filter(c => c.id !== chatId));
                renderHistoryList();
                if (currentChat && currentChat.id === chatId) {
                    initializeAppUI();
                }
            }
        };
        app.downloadImage = async (url, filename) => {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                URL.revokeObjectURL(link.href);
            } catch (e) { window.open(url, '_blank'); }
        };
        app.copyCode = (button) => {
            const code = button.closest('.code-block').querySelector('code').innerText;
            navigator.clipboard.writeText(code).then(() => {
                const originalText = button.innerHTML;
                button.innerText = 'Tersalin!';
                setTimeout(() => button.innerHTML = originalText, 2000);
            });
        };
        
        // --- Code Preview Functionality ---
        app.previewCode = (button) => {
            const codeBlock = button.closest('.code-block');
            const code = codeBlock.querySelector('code').innerText;
            const lang = codeBlock.querySelector('.code-lang').innerText.toLowerCase();
            
            currentCodePreview = { lang, code };

            const editor = document.getElementById('code-editor-textarea');
            editor.value = code;
            
            updateCodePreview(code, lang);

            document.getElementById('code-preview-modal').classList.add('visible');
        };

        function updateCodePreview(code, lang) {
            const iframe = document.getElementById('code-preview-iframe');
            let doc = '';

            const template = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <style>
                        body { 
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
                            padding: 1.5rem; 
                            background-color: #fff;
                            color: #111;
                        }
                        /* CSS_PLACEHOLDER */
                    </style>
                </head>
                <body>
                    <h1>Contoh Pratinjau</h1>
                    <p>Elemen ini akan terpengaruh oleh kode CSS Anda.</p>
                    <button id="myButton">Tombol Contoh</button>
                    
                    <script>
                    window.onerror = function(message, source, lineno, colno, error) {
                        document.body.innerHTML = '<pre style="color: red; font-size: 16px;">JavaScript Error:\\n' + message + '</pre>';
                        return true;
                    };
                    try {
                        // JS_PLACEHOLDER
                    } catch (e) {
                        document.body.innerHTML = '<pre style="color: red; font-size: 16px;">' + e + '</pre>';
                    }
                    <\/script>
                </body>
                </html>
            `;

            switch (lang) {
                case 'html':
                    if (code.trim().toLowerCase().includes('<html')) {
                        doc = code;
                    } else {
                        doc = template.replace(/<h1>.*<\/button>/s, code);
                    }
                    break;
                case 'css':
                    doc = template.replace('/* CSS_PLACEHOLDER */', code);
                    break;
                case 'javascript':
                case 'js':
                    doc = template.replace('// JS_PLACEHOLDER', code);
                    break;
                default:
                    doc = `<html><body style="background-color: #1e1e1e; color: #e0e0e0; font-family: monospace; white-space: pre; padding: 1rem;">${code.replace(/</g, "&lt;")}</body></html>`;
            }
            
            iframe.srcdoc = doc;
        }

        function handleRequestFix() {
            const editedCode = document.getElementById('code-editor-textarea').value;
            const { lang } = currentCodePreview;
            
            const prompt = `Tolong perbaiki atau tambahkan fitur pada kode ${lang} berikut. Saya ingin...\n\n\`\`\`${lang}\n${editedCode}\n\`\`\``;
            
            hideCodePreview();
            
            const chatInput = document.getElementById('chat-input');
            chatInput.value = prompt;
            chatInput.style.height = 'auto';
            chatInput.style.height = `${chatInput.scrollHeight}px`;
            chatInput.focus();
        }

        function hideCodePreview() {
            document.getElementById('code-preview-modal').classList.remove('visible');
            document.getElementById('code-preview-iframe').srcdoc = '';
        }

        function handleImageUpload(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedImageBase64 = e.target.result;
                document.getElementById('image-preview-thumbnail').src = uploadedImageBase64;
                document.getElementById('image-preview-container').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function resetImagePreview() {
            uploadedImageBase64 = null;
            document.getElementById('file-input').value = '';
            document.getElementById('image-preview-container').style.display = 'none';
        }
        
        function setupCalculator() {
            const currentInputEl = document.getElementById('calculator-current-input');
            const expressionEl = document.getElementById('calculator-expression');
            const buttons = document.querySelectorAll('.calc-btn');
            
            let currentInput = '0';
            let expression = '';
            let lastWasOperator = false;

            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    const value = button.textContent;

                    if (!isNaN(value) || value === ',') {
                        if (currentInput === '0' && value !== ',') currentInput = value;
                        else if (!(value === ',' && currentInput.includes(','))) currentInput += value;
                        lastWasOperator = false;
                    } else if (['+', '-', '×', '÷'].includes(value)) {
                        if (lastWasOperator) expression = expression.slice(0, -2) + ` ${value} `;
                        else expression += `${currentInput.replace(',', '.')} ${value} `;
                        currentInput = '0';
                        lastWasOperator = true;
                    } else if (value === '%') {
                        currentInput = String(parseFloat(currentInput.replace(',', '.')) / 100).replace('.', ',');
                    } else if (value === '⌫') {
                        currentInput = currentInput.slice(0, -1) || '0';
                    } else if (value === 'C') {
                        currentInput = '0'; expression = ''; lastWasOperator = false;
                    } else if (value === '=') {
                        if (expression && !lastWasOperator) {
                             expression += currentInput.replace(',', '.');
                             try {
                                 let evalExpression = expression.replace(/×/g, '*').replace(/÷/g, '/');
                                 currentInput = String(eval(evalExpression)).replace('.', ',');
                             } catch { currentInput = 'Error'; }
                             expression = ''; lastWasOperator = false;
                        }
                    }
                    currentInputEl.textContent = currentInput;
                    expressionEl.textContent = expression.replace(/\*/g, '×').replace(/\//g, '÷');
                });
            });
        }
        
        async function handleAiCalculatorUpload(file) {
            const resultDiv = document.getElementById('ai-calculator-result');
            resultDiv.innerHTML = '<div class="spinner" style="margin: 0 auto;"></div><p style="text-align:center;">Menganalisis gambar...</p>';
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const imageBase64 = e.target.result;
                try {
                    const prompt = "Anda adalah seorang ahli matematika. Analisis gambar ini, identifikasi soal matematika di dalamnya, dan berikan jawaban beserta langkah-langkah dan rumus yang digunakan untuk menyelesaikannya.";
                    const history = [{ role: 'user', apiContent: prompt }];
                    const response = await queryGemini(history, imageBase64);
                    resultDiv.innerHTML = response.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                } catch (error) {
                    console.error("AI Calculator Error:", error);
                    resultDiv.textContent = `Gagal menganalisis gambar: ${error.message}`;
                }
            };
            reader.readAsDataURL(file);
        }

        // --- MODAL ---
        function showModal(title, content, footerContent = '') {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('modal-footer').innerHTML = footerContent;
            document.getElementById('modal').classList.add('visible');
        }

        function hideModal() {
            document.getElementById('modal').classList.remove('visible');
        }

        function showStorageConsentModal(callback) {
            const title = "Pemberitahuan Privasi & Penyimpanan";
            const content = "<p>Aplikasi ini akan menyimpan data akun dan riwayat percakapan Anda di penyimpanan lokal (localStorage) pada perangkat ini. Data ini tidak dikirim ke server dan hanya dapat diakses dari browser Anda.</p><p>Dengan melanjutkan, Anda setuju dengan penyimpanan data ini.</p>";
            const footer = '<button id="consent-btn" class="btn">Saya Mengerti & Lanjutkan</button>';
            showModal(title, content, footer);
            document.getElementById('consent-btn').onclick = () => {
                localStorage.setItem('pi_new_storage_consent', true);
                hideModal();
                callback();
            };
            document.getElementById('modal-close-btn').style.display = 'none';
        }
        
        // --- EVENT LISTENERS ---
        function initEventListeners() {
            document.getElementById('menu-calculator-btn').addEventListener('click', () => navigate('calculator-view'));
            document.getElementById('back-to-chat-from-calculator').addEventListener('click', () => navigate('chat-view'));
            setupCalculator();
            document.getElementById('ai-calc-upload-btn').addEventListener('click', () => document.getElementById('ai-calc-file-input').click());
            document.getElementById('ai-calc-file-input').addEventListener('change', e => { if (e.target.files[0]) handleAiCalculatorUpload(e.target.files[0]); });
            
            const menuBtn = document.getElementById('hamburger-btn');
            const overlay = document.getElementById('overlay');
            menuBtn.addEventListener('click', () => document.body.classList.toggle('menu-open'));
            overlay.addEventListener('click', () => document.body.classList.remove('menu-open'));
            document.querySelectorAll('#sidebar-menu a').forEach(el => el.addEventListener('click', () => document.body.classList.remove('menu-open')));
            
            document.getElementById('menu-new-chat-btn').addEventListener('click', createNewChatAndShow);
            document.getElementById('menu-history-btn').addEventListener('click', () => { renderHistoryList(); navigate('history-view'); });
            document.getElementById('menu-contact-btn').addEventListener('click', () => navigate('contact-view'));
            document.getElementById('menu-logout-btn').addEventListener('click', handleLogout);
            document.getElementById('theme-toggle-btn').addEventListener('click', toggleTheme);
            document.getElementById('menu-custom-bg-btn').addEventListener('click', () => document.getElementById('custom-bg-input').click());
            document.getElementById('custom-bg-input').addEventListener('change', handleCustomBgUpload);
            document.getElementById('menu-remove-bg-btn').addEventListener('click', removeCustomBg);

            
            document.getElementById('go-to-register-btn').addEventListener('click', () => navigate('register-view'));
            document.getElementById('go-to-login-btn').addEventListener('click', () => navigate('login-view'));
            document.getElementById('back-to-chat-from-history').addEventListener('click', () => navigate('chat-view'));
            document.getElementById('back-to-chat-from-contact').addEventListener('click', () => navigate('chat-view'));
            
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            
            const chatInput = document.getElementById('chat-input');
            document.getElementById('send-btn').addEventListener('click', processUserInput);
            chatInput.addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); processUserInput(); } });
            chatInput.addEventListener('input', () => { chatInput.style.height = 'auto'; chatInput.style.height = `${chatInput.scrollHeight}px`; });
            
            document.getElementById('upload-btn').addEventListener('click', () => document.getElementById('file-input').click());
            document.getElementById('file-input').addEventListener('change', e => { if (e.target.files[0]) handleImageUpload(e.target.files[0]); });
            document.getElementById('remove-image-btn').addEventListener('click', resetImagePreview);
            
            document.getElementById('modal-close-btn').addEventListener('click', hideModal);

            // Code Preview Modal Listeners
            document.getElementById('code-preview-close-btn').addEventListener('click', hideCodePreview);
            document.getElementById('request-fix-btn').addEventListener('click', handleRequestFix);
            document.getElementById('code-editor-textarea').addEventListener('input', (e) => {
                updateCodePreview(e.target.value, currentCodePreview.lang);
            });
            
            document.querySelectorAll('.password-toggle').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const input = toggle.previousElementSibling;
                    const isVisible = input.type === 'text';
                    input.type = isVisible ? 'password' : 'text';
                    toggle.textContent = isVisible ? 'visibility_off' : 'visibility';
                });
            });
        }
        
        // --- START THE APP ---
        startApp();
    });
    </script>
</body>
</html>
